<!--
  Any copyright is dedicated to the Public Domain.
  http://creativecommons.org/publicdomain/zero/1.0/
-->
<html>
<head>
  <title>Indexed Database Property Test</title>

  <script type="text/javascript" src="/MochiKit/packed.js"></script>
  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>

  <script type="text/javascript;version=1.7">
    function testSteps()
    {
      const CONSTRAINT_ERR =
        Components.interfaces.nsIIDBDatabaseException.CONSTRAINT_ERR;
      const READ_WRITE = Components.interfaces.nsIIDBTransaction.READ_WRITE;

      const name = window.location.pathname;
      const description = "My Test Database";

      const objectStoreName = "People";

      const objectStoreData = [
        { key: "237-23-7732", value: { name: "Bob", height: 60, weight: 120 } },
        { key: "237-23-7733", value: { name: "Ann", height: 52, weight: 110 } },
        { key: "237-23-7734", value: { name: "Ron", height: 73, weight: 180 } },
        { key: "237-23-7735", value: { name: "Sue", height: 58, weight: 130 } },
        { key: "237-23-7736", value: { name: "Joe", height: 65, weight: 150 } },
        { key: "237-23-7737", value: { name: "Pat", height: 65 } },
        { key: "237-23-7738", value: { name: "Mel", height: 66, weight: {} } }
      ];

      const badObjectStoreData = [
        { key: "237-23-7739", value: { name: "Rob", height: 65 } },
        { key: "237-23-7740", value: { name: "Jen", height: 66, weight: {} } }
      ];

      const indexData = [
        { name: "weight", keyPath: "weight", unique: false }
      ];

      const objectStoreDataWeightSort = [
        { key: "237-23-7733", value: { name: "Ann", height: 52, weight: 110 } },
        { key: "237-23-7732", value: { name: "Bob", height: 60, weight: 120 } },
        { key: "237-23-7735", value: { name: "Sue", height: 58, weight: 130 } },
        { key: "237-23-7736", value: { name: "Joe", height: 65, weight: 150 } },
        { key: "237-23-7734", value: { name: "Ron", height: 73, weight: 180 } }
      ];

      let request = moz_indexedDB.open(name, description);
      request.onerror = errorHandler;
      request.onsuccess = grabEventAndContinueHandler;
      let event = yield;

      let db = event.result;

      request = db.createObjectStore(objectStoreName, "");
      request.onerror = errorHandler;
      request.onsuccess = grabEventAndContinueHandler;
      event = yield;

      let objectStore = event.result;

      let addedData = 0;
      for (let i in objectStoreData) {
        request = objectStore.add(objectStoreData[i].value,
                                  objectStoreData[i].key);
        request.onerror = errorHandler;
        request.onsuccess = function(event) {
          if (++addedData == objectStoreData.length) {
            testGenerator.send(event);
          }
        }
      }
      event = yield;

      addedData = 0;
      for (let i in indexData) {
        request = objectStore.createIndex(indexData[i].name,
                                          indexData[i].keyPath,
                                          indexData[i].unique);
        request.onerror = errorHandler;
        request.onsuccess = function(event) {
          if (++addedData == indexData.length) {
            is(objectStore.indexNames.length, addedData, "Good index count");
            testGenerator.send(event);
          }
        }
      }
      event = yield;

      addedData = 0;
      for (let i in badObjectStoreData) {
        request = objectStore.add(badObjectStoreData[i].value,
                                  badObjectStoreData[i].key);
        request.onerror = errorHandler;
        request.onsuccess = function(event) {
          if (++addedData == badObjectStoreData.length) {
            SimpleTest.executeSoon(function() { testGenerator.next() });
          }
        }
      }
      yield;

      objectStore = db.objectStore(objectStoreName);

      let keyIndex = 0;

      request = objectStore.index("weight").openCursor();
      request.onerror = errorHandler;
      request.onsuccess = function (event) {
        let cursor = event.result;
        if (cursor) {
          is(cursor.key, objectStoreDataWeightSort[keyIndex].value.weight,
             "Correct key");
          is(cursor.value, objectStoreDataWeightSort[keyIndex].key,
             "Correct value");
          keyIndex++;

          cursor.continue();
        }
        else {
          testGenerator.next();
        }
      }
      yield;

      is(keyIndex, objectStoreDataWeightSort.length, "Saw all weights");

      keyIndex = 0;

      request = objectStore.openCursor();
      request.onerror = errorHandler;
      request.onsuccess = function (event) {
        let cursor = event.result;
        if (cursor) {
          keyIndex++;
          cursor.continue();
        }
        else {
          testGenerator.next();
        }
      }
      yield;

      is(keyIndex, objectStoreData.length + badObjectStoreData.length,
         "Saw all people");

      finishTest();
      yield;
    }
  </script>
  <script type="text/javascript;version=1.7" src="helpers.js"></script>
</head>

<body onload="runTest();"></body>

</html>
